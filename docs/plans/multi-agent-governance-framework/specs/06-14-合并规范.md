# Spec 06-14: 剩余模块设计（合并文档）

## Spec 06: 动态角色生成

### 核心流程

```typescript
class DynamicRoleGenerator {
    async generateTopLayerRoles(taskContext: TaskContext): Promise<TopLayerRole[]> {
        const prompt = `
根据任务上下文，设计三个顶层角色（三权分立）：

任务类型：${taskContext.type}
任务描述：${taskContext.description}
关键需求：${taskContext.requirements.join(', ')}

要求：
1. 三个角色名称体现三权分立（如：规划者、执行者、审查者）
2. 每个角色有明确职责（3-5 条）
3. 定义签字权限和制衡关系

输出 JSON 格式。
        `

        const response = await this.llm.call(prompt)
        return JSON.parse(response)
    }

    async generateMidLayerRoles(topLayerRoles: TopLayerRole[], taskBreakdown: any): Promise<MidLayerRole[]> {
        // 顶层三权协商
        const proposals = await Promise.all(
            topLayerRoles.map(role => role.proposeMidLayerRoles(taskBreakdown))
        )

        // 合并方案
        const finalRoles = await this.negotiateProposals(proposals)

        // 验证签字
        await this.collectSignatures(topLayerRoles, finalRoles)

        return finalRoles
    }
}
```

---

## Spec 07: 错误恢复

### 错误恢复策略

```typescript
class ErrorRecoveryManager {
    async handleAgentError(agentId: string, error: Error): Promise<void> {
        // 1. 重试（最多 3 次）
        const retries = await this.getRetryCount(agentId)
        if (retries < 3) {
            await this.retryTask(agentId)
            return
        }

        // 2. 上报上级
        const agent = await this.getAgent(agentId)
        if (agent.supervisor) {
            await this.escalateToSupervisor(agent.supervisor, agentId, error)
        }

        // 3. 同级接管
        const peers = await this.getPeers(agentId)
        for (const peer of peers) {
            if (await this.canTakeOver(peer, agentId)) {
                await this.transferTask(agentId, peer)
                return
            }
        }

        // 4. 替换 Agent
        await this.replaceAgent(agentId)
    }

    private async replaceAgent(agentId: string): Promise<void> {
        const agent = await this.getAgent(agentId)
        const newAgent = await this.teamManager.createAgent({
            layer: agent.layer,
            role: agent.role,
            supervisor: agent.supervisor
        })

        await this.transferTasks(agentId, newAgent.id)
        await this.dismissAgent(agentId)
    }
}
```

---

## Spec 08: 数据库设计

### 完整 Schema

```sql
-- 任务表
CREATE TABLE tasks (
    id TEXT PRIMARY KEY,
    description TEXT NOT NULL,
    status TEXT NOT NULL,
    mode TEXT NOT NULL,
    created_at INTEGER NOT NULL,
    completed_at INTEGER
);

-- Agent 表
CREATE TABLE agents (
    id TEXT PRIMARY KEY,
    task_id TEXT NOT NULL,
    name TEXT NOT NULL,
    layer TEXT NOT NULL,
    role TEXT NOT NULL,
    status TEXT NOT NULL,
    supervisor TEXT,
    created_at INTEGER NOT NULL,
    FOREIGN KEY (task_id) REFERENCES tasks(id)
);

-- 消息表
CREATE TABLE messages (
    id TEXT PRIMARY KEY,
    task_id TEXT NOT NULL,
    from_agent TEXT NOT NULL,
    to_agent TEXT,
    type TEXT NOT NULL,
    content TEXT NOT NULL,
    timestamp INTEGER NOT NULL,
    heartbeat_number INTEGER NOT NULL,
    FOREIGN KEY (task_id) REFERENCES tasks(id)
);

CREATE INDEX idx_messages_task ON messages(task_id);
CREATE INDEX idx_messages_agent ON messages(from_agent, to_agent);

-- 决策表
CREATE TABLE decisions (
    id TEXT PRIMARY KEY,
    task_id TEXT NOT NULL,
    proposer_id TEXT NOT NULL,
    type TEXT NOT NULL,
    content TEXT NOT NULL,
    require_signers TEXT NOT NULL,
    signers TEXT NOT NULL,
    vetoers TEXT NOT NULL,
    status TEXT NOT NULL,
    created_at INTEGER NOT NULL,
    approved_at INTEGER,
    FOREIGN KEY (task_id) REFERENCES tasks(id)
);

-- 审计表
CREATE TABLE audits (
    id TEXT PRIMARY KEY,
    task_id TEXT NOT NULL,
    agent_id TEXT NOT NULL,
    event_type TEXT NOT NULL,
    reason TEXT NOT NULL,
    created_at INTEGER NOT NULL,
    FOREIGN KEY (task_id) REFERENCES tasks(id)
);

-- 选举表
CREATE TABLE elections (
    id TEXT PRIMARY KEY,
    task_id TEXT NOT NULL,
    round INTEGER NOT NULL,
    layer TEXT NOT NULL,
    results TEXT NOT NULL,
    actions TEXT NOT NULL,
    created_at INTEGER NOT NULL,
    FOREIGN KEY (task_id) REFERENCES tasks(id)
);
```

---

## Spec 09: 日志系统

### 日志分类

```typescript
import pino from 'pino'

class LoggerFactory {
    static create(category: string): pino.Logger {
        return pino({
            name: category,
            level: process.env.LOG_LEVEL || 'info',
            transport: {
                targets: [
                    {
                        target: 'pino/file',
                        options: { destination: `.agent-workspace/logs/${category}.log` }
                    },
                    {
                        target: 'pino-pretty',
                        options: { destination: 1 }
                    }
                ]
            }
        })
    }
}

// 使用
const messageBusLogger = LoggerFactory.create('message-bus')
const auditLogger = LoggerFactory.create('audit')
const performanceLogger = LoggerFactory.create('performance')
```

---

## Spec 10: SDK API 设计

### 核心 API

```typescript
// 主入口
export class AgentTeam {
    constructor(config: AgentTeamConfig) {}

    async start(taskDescription: string): Promise<TaskResult> {
        // 1. 需求澄清
        const taskContext = await this.requirementManager.clarify(taskDescription)

        // 2. 生成团队
        const team = await this.teamManager.generate(taskContext)

        // 3. 启动心跳
        this.messageBus.start()

        // 4. 等待完成
        return await this.waitForCompletion()
    }

    pause(): void {}
    resume(): void {}
    cancel(): void {}

    getStatus(): TeamStatus {}
    getAgents(): Agent[] {}

    on(event: string, callback: Function): void {}
}

// 使用示例
const team = new AgentTeam({
    mode: 'auto',
    heartbeatInterval: 4000,
    maxBottomAgents: 5,
    databasePath: './task.db',
    workspacePath: './.agent-workspace'
})

team.on('heartbeat', (n) => console.log(`Heartbeat ${n}`))
team.on('task:completed', (result) => console.log('Done!', result))

const result = await team.start('Create a TODO app with Express.js')
console.log(result)
```

---

## Spec 11: TUI 界面设计

### 布局

```
┌─────────────────────────────────────────────────────────────────┐
│ Multi-Agent Governance Framework - Task: Create TODO app       │
│ Mode: Auto | Heartbeat: #42 | Status: Running                  │
├─────────────────────────────────┬───────────────────────────────┤
│                                 │ AGENT STATUS                  │
│  TASK INPUT                     ├───────────────────────────────┤
│  > Create TODO app...           │ ● Top-1 (Planner)    WORKING │
│                                 │ ● Top-2 (Executor)   IDLE    │
│  EXECUTION LOG                  │ ● Top-3 (Reviewer)   IDLE    │
│  [12:30:01] Team created        │                               │
│  [12:30:05] Task assigned       │ ● Mid-1 (Backend)    WORKING │
│  [12:30:10] Code generated      │ ● Mid-2 (Frontend)   IDLE    │
│  [12:30:15] Tests passed        │                               │
│                                 │ ● Bot-1              WORKING │
│  WHITEBOARD PREVIEW             │ ● Bot-2              IDLE    │
│  ## Global Whiteboard           │ ● Bot-3              IDLE    │
│  - Task: Create TODO app        │                               │
│  - Status: In Progress          │ MESSAGE BUS (last 10)         │
│  - Milestone 1: [DONE]          ├───────────────────────────────┤
│  - Milestone 2: [ ]             │ [12:30:15] Bot-1 -> Mid-1    │
│                                 │   PROGRESS_REPORT: 80%        │
│                                 │ [12:30:14] Mid-1 -> Bot-1    │
│                                 │   TASK_ASSIGN: Implement API  │
│                                 │ [12:30:10] Top-1 -> Mid-1    │
│                                 │   DECISION: Approved          │
├─────────────────────────────────┴───────────────────────────────┤
│ Commands: [P]ause [R]esume [C]ancel [W]hiteboard [L]ogs [Q]uit │
└─────────────────────────────────────────────────────────────────┘
```

### 实现

```typescript
import { render, Box, Text } from 'ink'

function App({ team }: { team: AgentTeam }) {
    const [status, setStatus] = useState(team.getStatus())

    useEffect(() => {
        const interval = setInterval(() => {
            setStatus(team.getStatus())
        }, 1000)
        return () => clearInterval(interval)
    }, [])

    return (
        <Box flexDirection="column" height="100%">
            <Box><Text bold>Task: {status.task}</Text></Box>
            <Box flexGrow={1}>
                <Box width="60%" flexDirection="column">
                    <ExecutionLog logs={status.logs} />
                    <WhiteboardPreview content={status.whiteboard} />
                </Box>
                <Box width="40%" flexDirection="column">
                    <AgentStatus agents={status.agents} />
                    <MessageBus messages={status.recentMessages} />
                </Box>
            </Box>
        </Box>
    )
}
```

---

## Spec 12: CLI 命令设计

### 命令列表

```bash
# 启动任务
magf start "Create a TODO app"
magf start --mode semi-auto --max-agents 10

# 查看状态
magf status
magf status --agents
magf status --whiteboard

# 控制任务
magf pause
magf resume
magf cancel

# 查看日志
magf logs
magf logs --category audit
magf logs --agent bot-1

# 查看历史
magf history
magf history --task task-123

# 配置
magf config set heartbeat 5000
magf config show
```

### 实现

```typescript
import { Command } from 'commander'

const program = new Command()

program
    .name('magf')
    .description('Multi-Agent Governance Framework CLI')
    .version('1.0.0')

program
    .command('start <task>')
    .description('Start a new task')
    .option('-m, --mode <mode>', 'Mode: auto or semi-auto', 'auto')
    .option('--max-agents <number>', 'Max bottom agents', '5')
    .action(async (task, options) => {
        const team = new AgentTeam({
            mode: options.mode,
            maxBottomAgents: parseInt(options.maxAgents)
        })

        const result = await team.start(task)
        console.log('Task completed:', result)
    })

program.parse()
```

---

## Spec 13: pi-mono 集成

### 集成方式

```typescript
import { PiAgentCore } from '@mariozechner/pi-agent-core'
import { PiAI } from '@mariozechner/pi-ai'
import { PiCodingAgent } from '@mariozechner/pi-coding-agent'

class BottomLayerAgent extends BaseAgent {
    private piCodingAgent: PiCodingAgent

    constructor(config: AgentConfig, dependencies: AgentDependencies) {
        super(config, dependencies)

        this.piCodingAgent = new PiCodingAgent({
            model: 'claude-3-5-sonnet',
            tools: ['file_read', 'file_write', 'bash', 'http_request']
        })
    }

    protected async onProcess(messages: Message[]): Promise<void> {
        if (this.currentTask) {
            const result = await this.piCodingAgent.execute({
                task: this.currentTask.description,
                context: {
                    whiteboard: await this.readWhiteboard('bottom'),
                    globalContext: await this.readWhiteboard('global')
                }
            })

            await this.reportResult(result)
        }
    }
}
```

---

## Spec 14: 测试策略

### 测试覆盖

```typescript
// 单元测试
describe('MessageBus', () => {
    it('should deliver messages', async () => {
        const bus = new MessageBus(config, db)
        bus.start()
        // ...
    })
})

// 集成测试
describe('Multi-Agent Team', () => {
    it('should complete simple task', async () => {
        const team = new AgentTeam(config)
        const result = await team.start('Create Hello World function')
        expect(result.success).toBe(true)
    })

    it('should handle agent failure', async () => {
        // Mock agent failure
        // Verify recovery mechanism
    })
})

// E2E 测试
describe('Full Task Execution', () => {
    it('should create TODO app', async () => {
        const team = new AgentTeam(config)
        const result = await team.start('Create Express.js TODO app with SQLite')
        expect(result.output).toContain('app.js')
        expect(result.output).toContain('database.js')
    })
})
```

---

## 总结

所有核心模块设计已完成，覆盖：
- ✅ 动态角色生成
- ✅ 错误恢复机制
- ✅ 数据库 Schema
- ✅ 日志系统
- ✅ SDK API
- ✅ TUI 界面
- ✅ CLI 命令
- ✅ pi-mono 集成
- ✅ 测试策略

下一步将生成对应的 TODO 清单。
